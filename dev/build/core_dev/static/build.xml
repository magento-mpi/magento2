<?xml version="1.0" encoding="utf-8"?>
<!--
/**
 * Apache Ant's build file for core development static tests
 *
 * {license_notice}
 *
 * @copyright  {copyright}
 * @license    {license_link}
 */
-->
<project name="Core Development Static Tests" basedir="../../../../" default="_static_tests_all">
    <import file="../util.xml"/>

    <target name="_jshint_path_substitution" description="JsHint Javascript file path substitution from environment variable">
        <fail unless="phpunit_config_file" message="Property 'phpunit_config_file' must be defined"/>
        <fail unless="env.JsHintPath" message="Environment variable 'JsHintPath' must be defined"/>
        <replace file="${phpunit_config_file}">
            <replacefilter token="{{tests_jshint_path}}" value="${env.JsHintPath}"/>
        </replace>
    </target>

    <target name="_static_tests_no_js" depends="_product_location" description="All static tests without JS static test">
        <copy file="${basedir}/dev/build/core_dev/static/phpunit.php.xml"
              tofile="${product_root_dir}/dev/tests/static/phpunit.xml" overwrite="true"/>
        <copy file="${basedir}/dev/build/core_dev/static/pdepend.xml"
              tofile="${product_root_dir}/dev/tests/static/pdepend.xml" overwrite="true"/>
        <replace file="${product_root_dir}/dev/tests/static/pdepend.xml">
            <replacefilter token="{{pdepend_cache_path}}" value="${product_root_dir}/var/pdepend"/>
        </replace>
        <exec dir="${product_root_dir}/dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/static_tests_no_js.xml"/>
        </exec>
        <delete dir="${product_root_dir}/var/pdepend"/>
    </target>

    <target name="_code_legacy_tests" depends="_product_location" description="Code Legacy Tests">
        <copy file="${basedir}/dev/build/core_dev/static/phpunit.legacy.xml"
              tofile="${product_root_dir}/dev/tests/static/phpunit.xml" overwrite="true"/>
        <exec dir="${product_root_dir}/dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/code_legacy_tests.xml"/>
        </exec>
    </target>

    <target name="_code_integrity_tests" depends="_product_location" description="Code Integrity Tests">
        <copy file="${basedir}/dev/build/core_dev/static/phpunit.integrity.xml"
              tofile="${product_root_dir}/dev/tests/static/phpunit.xml" overwrite="true"/>
        <exec dir="${product_root_dir}/dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/code_integrity_tests.xml"/>
        </exec>
    </target>

    <target name="_sanity_check" depends="_product_location" description="Static sanity check">
        <fail unless="product_edition_code" message="Property 'product_edition_code' must be defined"/>
        <exec executable="php" failonerror="true">
            <arg line="-f ${basedir}/dev/build/publication/sanity/sanity.php --
                -w ${product_root_dir}
                -c ${basedir}/dev/build/publication/sanity/${product_edition_code}.xml
                -v
                "/>
        </exec>
    </target>

    <target name="static_tests_ee" depends="_server_info" description="Static tests for EE">
        <antcall>
            <param name="license_replacement_enabled" value="true"/>
            <param name="product_edition_code" value="ee"/>
            <target name="_product_edition"/>
            <target name="_static_tests_no_js"/>
            <target name="_sanity_check"/>
        </antcall>
    </target>

    <target name="static_tests_ce" depends="_server_info" description="Static tests for CE">
        <antcall>
            <param name="license_replacement_enabled" value="true"/>
            <param name="product_edition_code" value="ce"/>
            <target name="_product_edition"/>
            <target name="_static_tests_no_js"/>
            <target name="_sanity_check"/>
        </antcall>
    </target>

    <target name="static_tests_js" depends="_server_info,_product_location" description="JS static tests">
        <copy file="${basedir}/dev/build/core_dev/static/phpunit.js.xml"
              tofile="${product_root_dir}/dev/tests/static/phpunit.xml" overwrite="true"/>
        <antcall target="_jshint_path_substitution">
            <param name="phpunit_config_file" value="${product_root_dir}/dev/tests/static/phpunit.xml"/>
        </antcall>
        <exec dir="${product_root_dir}/dev/tests/static" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/static_tests_js.xml"/>
        </exec>
    </target>

    <target name="code_legacy_tests_ee" depends="_server_info" description="Code Legacy Tests for Enterprise Edition">
        <antcall>
            <param name="product_edition_code" value="ee"/>
            <target name="_product_edition"/>
            <target name="_code_legacy_tests"/>
        </antcall>
    </target>

    <target name="code_legacy_tests_ce" depends="_server_info" description="Code Legacy Tests for Community Edition">
        <antcall>
            <param name="product_edition_code" value="ce"/>
            <target name="_product_edition"/>
            <target name="_code_legacy_tests"/>
        </antcall>
    </target>

    <target name="code_integrity_tests_ee" depends="_server_info" description="Code Integrity Tests for Enterprise Edition">
        <antcall>
            <param name="product_edition_code" value="ee"/>
            <target name="_product_edition"/>
            <target name="_code_integrity_tests"/>
        </antcall>
    </target>

    <target name="code_integrity_tests_ce" depends="_server_info" description="Code Integrity Tests for Community Edition">
        <antcall>
            <param name="product_edition_code" value="ce"/>
            <target name="_product_edition"/>
            <target name="_code_integrity_tests"/>
        </antcall>
    </target>

</project>
