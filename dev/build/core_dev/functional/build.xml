<?xml version="1.0" encoding="utf-8"?>
<!--
/**
 * Apache Ant's build file for core development functional tests
 *
 * {license_notice}
 *
 * @category   dev
 * @package    build
 * @copyright  {copyright}
 * @license    {license_link}
 */
-->
<project name="Core Development Functional Tests" basedir="../../../../" default="run">
    <import file="../util.xml"/>

    <target name="run-ee" depends="_server_info" description="Deploy multiple Magento instances and run functional tests on each of them simultaneously">
        <script language="javascript"><![CDATA[
            if (project.getProperty('env.bamboo_desired_agent')
                && project.getProperty('env.bamboo_desired_agent') != ''
                && project.getProperty('env.agent_name')
                && project.getProperty('env.bamboo_desired_agent') != project.getProperty('env.agent_name')
            ) {
                project.setProperty('error_message', 'This plan should be executed on agent "'
                    + project.getProperty('env.bamboo_desired_agent') + '", while currently it is executed on "'
                    + project.getProperty('env.agent_name') + '".');
            }
        ]]></script>
        <fail if="error_message" message="${error_message}"/>

        <fail if="max_instances" message="'max_instances' must be not set explicitly, use 'instance_count' instead."/>
        <script language="javascript"><![CDATA[
            var errorMessages = [];

            var variables = {
                build_customization_dir: '',
                db_host: '',
                db_name_prefix: '',
                db_user: '',
                db_password: '',
                deploy_directory: '',
                http_host: ' (e.g. http://myhost.com/mypath/)',
                https_host: ' (e.g. https://myhost.com/mypath/)',
                instance_count: '',
                selenium_browser: ' (e.g. firefox, googlechrome etc; see server.yml.dist)',
                selenium_host: '',
                selenium_port: '',
                selenium_timeout: '',
            };
            for (var name in variables) {
                if (project.getProperty('env.' + name) === null) {
                    errorMessages.push('Environment variable "' + name + '" must be defined' + variables[name] + '.');
                }
            }

            variables = {
                executer_options: '',
                instance_count: '',
                tests_executed: ' (relative path or few paths combined into one mask, for instance testsuite/{dir1/subdir1/*name1,dir2/*subdir2*,dir3/name3*})',
            };
            for (name in variables) {
                if (project.getProperty('env.bamboo_' + name) === null) {
                    errorMessages.push('Bamboo variable "' + name + '" must be defined' + variables[name] + '.');
                }
            }

            if (errorMessages.length > 0) {
                project.setProperty('error_message', errorMessages.join('\n'));
            } else {
                project.setProperty('max_instances', Math.min(project.getProperty('env.instance_count'),
                    project.getProperty('env.bamboo_instance_count')
                ));
                var echo = project.createTask('echo');
                echo.setMessage('Maximum ' + project.getProperty('env.instance_count')
                    + ' instances supported by environment, '
                    + project.getProperty('env.bamboo_instance_count') + ' expected by plan.');
                echo.execute();
            }
        ]]></script>

        <fail if="error_message" message="${error_message}"/>

        <property name="dir.build_directory" location="${env.deploy_directory}/${env.build.key}"/>
        <delete dir="${dir.build_directory}"/>

        <antcall target="_product_edition">
            <param name="product_edition_code" value="ee"/>
        </antcall>

        <copy file="${basedir}/${env.build_customization_dir}/composer.json" failonerror="true" overwrite="true"
              tofile="${basedir}/dev/tests/functional/composer.json"/>

        <exec executable="/usr/local/bin/composer" dir="${basedir}/dev/tests/functional/" failonerror="true">
            <arg line="install"/>
        </exec>

        <exec executable="php" dir="${basedir}/dev/tests/functional/" failonerror="true">
            <arg line="utils/generate.php"/>
        </exec>

        <script language="javascript"><![CDATA[
            var parallel = project.createTask('parallel');

            var maxInstances = project.getProperty('max_instances');
            for (var instanceIndex = 0; instanceIndex < maxInstances; instanceIndex++) {
                var antcall = project.createTask('antcall');
                antcall.setTarget('deploy-magento-instance');
                antcall.setInheritAll(true);

                var param = antcall.createParam();
                param.setName('instanceIndex');
                param.setValue(instanceIndex);

                parallel.addTask(antcall);
            }

            parallel.execute();
        ]]></script>

        <exec executable="phpunit" failonerror="true" dir="${dir.build_directory}/instance-0/dev/tests/functional/">
            <arg line="--log-junit ${basedir}/test-cases-report.xml
                --bootstrap config/bootstrap-with-cleanup-enabled.php
                 ${env.bamboo_executer_options}
                "/>
        </exec>
    </target>

    <target name="run-ce" depends="_server_info" description="Deploy multiple Magento instances and run functional tests on each of them simultaneously">
        <script language="javascript"><![CDATA[
            if (project.getProperty('env.bamboo_desired_agent')
                && project.getProperty('env.bamboo_desired_agent') != ''
                && project.getProperty('env.agent_name')
                && project.getProperty('env.bamboo_desired_agent') != project.getProperty('env.agent_name')
            ) {
                project.setProperty('error_message', 'This plan should be executed on agent "'
                    + project.getProperty('env.bamboo_desired_agent') + '", while currently it is executed on "'
                    + project.getProperty('env.agent_name') + '".');
            }
        ]]></script>
        <fail if="error_message" message="${error_message}"/>

        <fail if="max_instances" message="'max_instances' must be not set explicitly, use 'instance_count' instead."/>
        <script language="javascript"><![CDATA[
            var errorMessages = [];

            var variables = {
                build_customization_dir: '',
                db_host: '',
                db_name_prefix: '',
                db_user: '',
                db_password: '',
                deploy_directory: '',
                http_host: ' (e.g. http://myhost.com/mypath/)',
                https_host: ' (e.g. https://myhost.com/mypath/)',
                instance_count: '',
                selenium_browser: ' (e.g. firefox, googlechrome etc; see server.yml.dist)',
                selenium_host: '',
                selenium_port: '',
                selenium_timeout: '',
            };
            for (var name in variables) {
                if (project.getProperty('env.' + name) === null) {
                    errorMessages.push('Environment variable "' + name + '" must be defined' + variables[name] + '.');
                }
            }

            variables = {
                executer_options: '',
                instance_count: '',
                tests_executed: ' (relative path or few paths combined into one mask, for instance testsuite/{dir1/subdir1/*name1,dir2/*subdir2*,dir3/name3*})',
            };
            for (name in variables) {
                if (project.getProperty('env.bamboo_' + name) === null) {
                    errorMessages.push('Bamboo variable "' + name + '" must be defined' + variables[name] + '.');
                }
            }

            if (errorMessages.length > 0) {
                project.setProperty('error_message', errorMessages.join('\n'));
            } else {
                project.setProperty('max_instances', Math.min(project.getProperty('env.instance_count'),
                    project.getProperty('env.bamboo_instance_count')
                ));
                var echo = project.createTask('echo');
                echo.setMessage('Maximum ' + project.getProperty('env.instance_count')
                    + ' instances supported by environment, '
                    + project.getProperty('env.bamboo_instance_count') + ' expected by plan.');
                echo.execute();
            }
        ]]></script>

        <fail if="error_message" message="${error_message}"/>

        <property name="dir.build_directory" location="${env.deploy_directory}/${env.build.key}"/>
        <delete dir="${dir.build_directory}"/>

        <antcall target="_product_edition">
            <param name="product_edition_code" value="ce"/>
        </antcall>

        <copy file="${basedir}/${env.build_customization_dir}/composer.json" failonerror="true" overwrite="true"
              tofile="${basedir}/dev/tests/functional/composer.json"/>

        <exec executable="/usr/local/bin/composer" dir="${basedir}/dev/tests/functional/" failonerror="true">
            <arg line="install"/>
        </exec>

        <exec executable="php" dir="${basedir}/dev/tests/functional/" failonerror="true">
            <arg line="utils/generate.php"/>
        </exec>

        <script language="javascript"><![CDATA[
            var parallel = project.createTask('parallel');

            var maxInstances = project.getProperty('max_instances');
            for (var instanceIndex = 0; instanceIndex < maxInstances; instanceIndex++) {
                var antcall = project.createTask('antcall');
                antcall.setTarget('deploy-magento-instance');
                antcall.setInheritAll(true);

                var param = antcall.createParam();
                param.setName('instanceIndex');
                param.setValue(instanceIndex);

                parallel.addTask(antcall);
            }

            parallel.execute();
        ]]></script>

        <exec executable="phpunit" failonerror="true" dir="${dir.build_directory}/instance-0/dev/tests/functional/">
            <arg line="--log-junit ${basedir}/test-cases-report.xml
                --bootstrap config/bootstrap-with-cleanup-enabled.php
                 ${env.bamboo_executer_options}
                "/>
        </exec>
    </target>

    <target name="deploy-magento-instance">
        <copy todir="${dir.build_directory}/instance-${instanceIndex}" failonerror="true">
            <fileset dir="${basedir}"/>
        </copy>

        <mkdir dir="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/var/logs"/>
        <mkdir dir="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/var/screenshots"/>
        <copy file="${basedir}/${env.build_customization_dir}/phpunit.xml" failonerror="true" overwrite="true"
              tofile="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/phpunit.xml"/>
        <copy todir="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/config/" failonerror="true" overwrite="true">
            <fileset dir="${basedir}/${env.build_customization_dir}/config/"/>
        </copy>

        <antcall target="_installation_requirements" inheritAll="true">
            <param name="product_root_dir" value="${dir.build_directory}/instance-${instanceIndex}"/>
        </antcall>

        <replace file="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/config/install.php">
            <replacefilter token="{{db_model}}" value="${env.db_model}"/>
            <replacefilter token="{{db_host}}" value="${env.db_host}"/>
            <replacefilter token="{{db_name}}" value="${env.db_name_prefix}${instanceIndex}"/>
            <replacefilter token="{{db_user}}" value="${env.db_user}"/>
            <replacefilter token="{{db_password}}" value="${env.db_password}"/>
            <replacefilter token="{{url}}" value="${env.http_host}${env.build.key}/instance-${instanceIndex}"/>
            <replacefilter token="{{secure_url}}" value="${env.http_host}${env.build.key}/instance-${instanceIndex}"/>
        </replace>

        <replace file="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/config/server.yml.dist">
            <replacefilter token="{{selenium_host}}" value="${env.selenium_host}"/>
            <replacefilter token="{{selenium_port}}" value="${env.selenium_port}"/>
            <replacefilter token="{{selenium_timeout}}" value="${env.selenium_timeout}"/>
            <replacefilter token="{{selenium_browser}}" value="${env.selenium_browser}"/>
        </replace>

        <replace file="${dir.build_directory}/instance-${instanceIndex}/dev/tests/functional/phpunit.xml">
            <replacefilter token="{{admin_url}}" value="${env.http_host}${env.build.key}/instance-${instanceIndex}/backend/"/>
            <replacefilter token="{{url}}" value="${env.http_host}${env.build.key}/instance-${instanceIndex}"/>
        </replace>

        <antcall target="_run_compiler">
            <param name="product_root_dir" value="${dir.build_directory}/instance-${instanceIndex}" />
        </antcall>
    </target>

    <target name="_run_compiler" description="Run DI compiler tool">
        <exec executable="php" failonerror="true" >
            <arg line='-f ${product_root_dir}/dev/tools/Magento/Tools/Di/compiler.php'/>
        </exec>
    </target>
</project>
