<?xml version="1.0" encoding="utf-8"?>
<!--
/**
 * Apache Ant's build file for core development integration tests
 *
 * {license_notice}
 *
 * @category   dev
 * @package    build
 * @copyright  {copyright}
 * @license    {license_link}
 */
-->
<project name="Core Development Integration Tests" basedir="../../../../" default="integration_tests_ee_mysql">
    <import file="../util.xml"/>

    <target name="_integration_tests_configuration" depends="_product_location" description="Generation of configuration for integration tests">
        <condition property="db_vendor_name" value="mysql">
            <not><isset property="db_vendor_name"/></not>
        </condition>
        <condition property="db_table_prefix" value="">
            <not><isset property="db_table_prefix"/></not>
        </condition>
        <condition property="app_mode" value="developer">
            <not><isset property="app_mode"/></not>
        </condition>
        <copy file="${basedir}/dev/build/core_dev/integration/local-${db_vendor_name}.xml" todir="${product_root_dir}/dev/tests/integration/etc" overwrite="true"/>
        <ant antfile="${basedir}/dev/build/core_dev/util.xml" target="_database_credential_substitution">
            <property name="db_config_file" value="${product_root_dir}/dev/tests/integration/etc/local-${db_vendor_name}.xml"/>
        </ant>
        <replace file="${product_root_dir}/dev/tests/integration/etc/local-${db_vendor_name}.xml">
            <replacefilter token="{{db_table_prefix}}" value="${db_table_prefix}"/>
        </replace>
        <copy file="${basedir}/dev/build/core_dev/integration/phpunit.xml" todir="${product_root_dir}/dev/tests/integration" overwrite="true"/>
        <replace file="${product_root_dir}/dev/tests/integration/phpunit.xml">
            <replacefilter token="{{local_config_file}}" value="etc/local-${db_vendor_name}.xml"/>
            <replacefilter token="{{app_mode}}" value="${app_mode}"/>
        </replace>
    </target>

    <target name="_integration_tests_magento" depends="_integration_tests_configuration" description="Product integration tests">
        <exec dir="${product_root_dir}/dev/tests/integration" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${basedir}/integration_tests_magento.xml"/>
        </exec>
    </target>

    <target name="_integration_tests_magento_xdebug" depends="_integration_tests_configuration" description="Product integration tests with Xdebug">
        <exec dir="${product_root_dir}/dev/tests/integration" executable="${basedir}/dev/build/bin/phpunit-with-xdebug.sh" failonerror="true">
            <arg line="--stderr --log-junit ${basedir}/integration_tests_magento_xdebug.xml"/>
        </exec>
    </target>

    <target name="integration_tests_ee_dev_mysql" depends="_server_info,_enterprise_edition" description="Integration tests in dev mode on MySQL for EE">
        <antcall target="_integration_tests_magento"/>
    </target>

    <target name="integration_tests_ee_mysql" depends="_server_info,_enterprise_edition" description="Integration tests on MySQL for EE">
        <antcall target="_integration_tests_magento">
            <param name="app_mode" value="default"/>
        </antcall>
    </target>

    <target name="integration_tests_ee_dev_mysql_tpfx" depends="_server_info,_enterprise_edition" description="Integration tests in dev mode with table prefix on MySQL for EE">
        <antcall target="_integration_tests_magento">
            <param name="db_table_prefix" value="pfx_"/>
        </antcall>
    </target>

    <target name="integration_tests_ee_dev_xd_mysql" depends="_server_info,_enterprise_edition" description="Integration tests in dev mode with Xdebug on MySQL for EE">
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>

    <target name="integration_tests_ee_xd_mysql" depends="_server_info,_enterprise_edition" description="Integration tests with Xdebug on MySQL for EE">
        <antcall target="_integration_tests_magento_xdebug">
            <param name="app_mode" value="default"/>
        </antcall>
    </target>

    <target name="integration_tests_ee_dev_xd_mysql_tpfx" depends="_server_info,_enterprise_edition" description="Integration tests in dev mode with Xdebug and table prefix on MySQL for EE">
        <antcall target="_integration_tests_magento_xdebug">
            <param name="db_table_prefix" value="pfx_"/>
        </antcall>
    </target>

    <target name="integration_tests_ce_dev_mysql" depends="_server_info,_community_edition" description="Integration tests in dev mode on MySQL for CE">
        <antcall target="_integration_tests_magento"/>
    </target>

    <target name="integration_tests_ce_mysql" depends="_server_info,_community_edition" description="Integration tests on MySQL for CE">
        <antcall target="_integration_tests_magento">
            <param name="app_mode" value="default"/>
        </antcall>
    </target>

    <target name="integration_tests_ce_dev_mysql_tpfx" depends="_server_info,_community_edition" description="Integration tests in dev mode with table prefix on MySQL for CE">
        <antcall target="_integration_tests_magento">
            <param name="db_table_prefix" value="pfx_"/>
        </antcall>
    </target>

    <target name="integration_tests_ce_dev_xd_mysql" depends="_server_info,_community_edition" description="Integration tests in dev mode with Xdebug on MySQL for CE">
        <antcall target="_integration_tests_magento_xdebug"/>
    </target>

    <target name="integration_tests_ce_xd_mysql" depends="_server_info,_community_edition" description="Integration tests with Xdebug on MySQL for CE">
        <antcall target="_integration_tests_magento_xdebug">
            <param name="app_mode" value="default"/>
        </antcall>
    </target>

    <target name="_integration_integrity_tests_magento" depends="_integration_tests_configuration" description="Product integration integrity tests">
        <exec dir="${product_root_dir}/dev/tests/integration" executable="phpunit" failonerror="true">
            <arg line="--log-junit ${product_root_dir}/integration_integrity_tests_magento.xml testsuite/Magento/Test/Integrity"/>
        </exec>
    </target>

    <target name="integration_integrity_tests_ee_dev_mysql" depends="_server_info,_enterprise_edition" description="Integration integrity tests in dev mode on MySQL for EE">
        <antcall target="_integration_integrity_tests_magento"/>
    </target>

    <target name="integration_integrity_tests_ee_mysql" depends="_server_info,_enterprise_edition" description="Integration integrity tests on MySQL for EE">
        <antcall target="_integration_integrity_tests_magento">
            <param name="app_mode" value="default"/>
        </antcall>
    </target>

    <target name="integration_integrity_tests_ce_dev_mysql" depends="_server_info,_community_edition" description="Integration integrity tests in dev mode on MySQL for CE">
        <antcall target="_integration_integrity_tests_magento"/>
    </target>

    <target name="integration_integrity_tests_ce_mysql" depends="_server_info,_community_edition" description="Integration integrity tests on MySQL for CE">
        <antcall target="_integration_integrity_tests_magento">
            <param name="app_mode" value="default"/>
        </antcall>
    </target>

    <target name="integration_tests_ce_xd_mysql_code_coverage" depends="_product_location" description="Code Coverage CE Integration Tests with Xdebug">
        <copy file="${product_root_dir}/dev/build/core_dev/integration/.htaccess.sample" failonerror="true" overwrite="true"
              tofile="${product_root_dir}/.htaccess"/>
        <antcall target="_code_coverage_configuration">
            <param name="configuration_file" value="${product_root_dir}/dev/build/core_dev/integration/phpunit.xml"/>
        </antcall>
        <antcall target="integration_tests_ce_xd_mysql"/>
    </target>

    <target name="integration_tests_ee_xd_mysql_code_coverage" depends="_product_location" description="Code Coverage EE Integration Tests with Xdebug">
        <copy file="${product_root_dir}/dev/build/core_dev/integration/.htaccess.sample" failonerror="true" overwrite="true"
              tofile="${product_root_dir}/.htaccess"/>
        <antcall target="_code_coverage_configuration">
            <param name="configuration_file" value="${product_root_dir}/dev/build/core_dev/integration/phpunit.xml"/>
        </antcall>
        <antcall target="integration_tests_ee_xd_mysql"/>
    </target>

</project>
