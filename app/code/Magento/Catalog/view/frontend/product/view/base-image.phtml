<?php
/**
 * {license_notice}
 *
 * @copyright   {copyright}
 * @license     {license_link}
 */

/**
 * Product media data template
 *
 * @var $this \Magento\Catalog\Block\Product\View\BaseImage
 */
?>
<?php
$_product = $this->getProduct();
$_helper = $this->helper('Magento\Catalog\Helper\Output');
$dataHelper = $this->helper('Magento\Core\Helper\Data');
$imageHelper = $this->helper('Magento\Catalog\Helper\Image');

$image = 'product_page_main_image';

$_resizedWidth = $this->getVar("{$image}:width");
$_resizedHeight = $this->getVar("{$image}:height") ?: $_resizedWidth ;

$_hasImage = ($_product->getImage() && $_product->getImage() != "no_selection") ? true : false;

$_isOldDisplayMode = 0;
$whiteBorders =  $this->getVar("product_image_white_borders");
$thumbWidth =  $this->getVar("product_page_more_views:width");
$thumbHeight =  $this->getVar("product_page_more_views:height") ? : $thumbWidth;
?>
<div data-role="media-gallery">
    <div class="product photo main">
        <div data-role="gallery-base-image-container">
            <a href="#" class="product photo magento-zoom<?php echo (!$_hasImage) ? ' isPlaceholder' : ''; ?>"
               id="base-image" data-role="zoom-image"
               data-large="<?php echo $this->helper('Magento\Catalog\Helper\Image')->init($_product, 'image'); ?>">
                <?php echo $this->getChildBlock('product.image.main')->setAddAttribute('itemprop="image"')->init($_product, $image)->toHtml() ?>
            </a>
            <script type="text/javascript">
                jQuery('[data-role=base-image-zoom]').attr('rel', '<?php echo $this->helper('Magento\Catalog\Helper\Image')->init($_product, 'image'); ?>');
            </script>
        </div>
        <div data-role="gallery-notice-container">
            <p class="notice" data-role="notice"></p>
        </div>
    </div>
    <?php if (count($this->getGalleryImages()) > 0): ?>

        <div class="product photo thumbs">
            <strong class="title"><?php echo __('More Views') ?></strong>
            <ul class="items thumbs">
                <?php foreach ($this->getGalleryImages() as $_image): ?>
                <?php
                if ($whiteBorders) {
                    $imageSmall  = (string)$imageHelper->init($_product, 'thumbnail', $_image->getFile())->resize($thumbWidth, $thumbHeight);
                    $imageMedium = (string)$imageHelper->init($_product, 'image', $_image->getFile())->resize($_resizedWidth, $_resizedHeight);
                } else {
                    $imageSmall  = (string)$imageHelper->init($_product, 'thumbnail', $_image->getFile())->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize($thumbWidth, $thumbHeight);
                    $imageMedium = (string)$imageHelper->init($_product, 'image', $_image->getFile())->constrainOnly(TRUE)->keepAspectRatio(TRUE)->keepFrame(FALSE)->resize($_resizedWidth,$_resizedHeight);
                }
                $imageLarge = $imageHelper->init($_product, 'image', $_image->getFile());
                if ($_isOldDisplayMode) {
                        $attributes = ' href="#" data-mage-init="';
                        $attributes .= $this->escapeHtml(
                            $dataHelper->jsonEncode(
                                array(
                                    'popupWindow' => array(
                                        'windowURL'  => $this->getGalleryUrl($_image),
                                        'windowName' => 'gallery',
                                        'width'      => 300,
                                        'height'     => 300,
                                        'status'     => 1,
                                        'scrollbars' => 1,
                                        'resizable'  => 1,
                                    )
                                )
                            )
                        );
                        $attributes .=  '"';
                    } else {
                        $attributes        = ' href="' . $imageLarge . '"';
                        $galleryAttributes = ' data-image-small="' . $imageSmall . '" data-image-medium="' . $imageMedium . '" data-image-large="' . $imageLarge . '"';
                        if ($_product->getImage() == $_image->getFile()) {
                            $galleryAttributes .= ' data-image-selected="true"';
                        }
                    };
                ?>
                    <li class="item thumb">
                        <a<?php echo $attributes; ?> class="magento-zoom" data-role="gallery-thumb"
                            <?php if (!$_isOldDisplayMode && $galleryAttributes): ?>
                                <?php echo $galleryAttributes ?>
                            <?php endif; ?>
                             title="<?php echo $this->escapeHtml($_image->getLabel()) ?>">
                            <span class="img"
                                  style="position:relative; z-index:1; display:block; width:<?php echo $thumbHeight; ?>px; height:<?php echo $thumbHeight; ?>px;">
                                <img itemprop="image"
                                     src="<?php echo $imageSmall; ?>"
                                     alt="<?php echo $this->escapeHtml($_image->getLabel()) ?>"/>
                            </span>
                        </a>
                    </li>
                <?php endforeach; ?>
            </ul>
        </div>
        <?php if ($_isOldDisplayMode): ?>
            <script type="text/javascript">
                (function($) {
                    head.js("<?php echo $this->getViewFileUrl('mage/popup-window.js')?>");
                })(jQuery);
            </script>
        <?php endif; ?>
    <?php endif; ?>
</div>
<?php if ($_hasImage): ?>
    <?php if (!$_isOldDisplayMode): ?>
    <script data-template="gallery-wrapper" type="text/x-jQuery-tmpl">
        <div class="product photo main">
            <div data-role="gallery-base-image-container"></div>
            <div data-role="gallery-notice-container"></div>
        </div>
        <div class="product photo thumbs" data-role="gallery-thumbs-container">
        </div>
        <div class="product photo buttons" data-role="gallery-buttons-container">
        </div>
    </script>
    <script data-template="gallery-buttons" type="text/x-jQuery-tmpl">
        <a class="gallery control prev" data-role="gallery-prev" href="#"></a>
        <a class="gallery control next" data-role="gallery-next" href="#"></a>
    </script>
    <script data-template="gallery-base-image" type="text/x-jQuery-tmpl">
        <a class="product photo{{if typeof hasImg !== 'undefined'}} isPlaceholder{{/if}}" href="#">
            <span class="img photo container" style="width:${width}px; height:${height}px; display: block; position: relative; overflow: hidden">
                <img data-role="zoom-image" class="photo image" width="${width}" itemprop="image" {{if !fullSizeMode}}data-large="${large}" src="${medium}"{{else}}src="${large}"{{/if}} alt="${title}"/>
            </span>
        </a>
    </script>
    <script data-template="gallery-thumbs" type="text/x-jQuery-tmpl">
        <strong class="title">${tumbsTitle}</strong>
        <ul class="items thumbs">
            {{each(index, img) images}}
            <li class="item thumb">
                <a title="${img.title}" data-index="${index}" data-role="gallery-thumb" href="#">
                        <span style="position:relative; z-index:1; display:block; width:${size.width}px; height:${size.height}px;" class="img">
                            <img alt="${img.title}" src="${img.small}" itemprop="image">
                        </span>
                </a>
            </li>
            {{/each}}
        </ul>
    </script>
    <?php endif; ?>
    <script data-template="zoom-display" type="text/x-jQuery-tmpl">
        <div class="magento-zoom-enlarged" data-role="zoom-container">
            <div data-role="zoom-inner"></div>
        </div>
    </script>
    <script data-template="zoom-enlarged-image" type="text/x-jQuery-tmpl">
        <img data-role="enlarged-image" src="${img}" />
    </script>
    <script data-template="zoom-track" type="text/z-jQuery-tmpl">
        <div data-role="zoom-track"></div>
    </script>
    <script data-template="zoom-lens" type="text/z-jQuery-tmpl">
        <div data-role="zoom-lens"></div>
    </script>
    <script data-template="notice" type="text/x-jQuery-tmpl">
        <p class="notice" data-role="notice">${text}</p>
    </script>
    <script type="text/javascript">
        (function($) {
        <?php if ($_isOldDisplayMode): ?>
            head.js("<?php echo $this->getViewFileUrl('mage/zoom.js')?>", function () {
                $('[data-role=media-gallery]').zoom({
                    controls: {
                        notice: {
                            text: '<?php echo $this->escapeJsQuote(__("Click on image to zoom")) ?>'
                        }
                    }
                });
            });

        <?php else: ?>
            head.js("<?php echo $this->getViewFileUrl('mage/zoom.js')?>",
                "<?php echo $this->getViewFileUrl('mage/gallery.js')?>",
                "<?php echo $this->getViewFileUrl('mage/gallery-fullscreen.js')?>",
                function() {
                    $('[data-role=media-gallery]')
                        .gallery({
                            sizes: {
                                small: {
                                    width: <?php echo $thumbWidth ?>,
                                    height: <?php echo $thumbHeight ?>
                                },
                                medium: {
                                    width: <?php echo $_resizedWidth ?>,
                                    height: <?php echo $_resizedHeight ?>
                                }
                            },
                            controls: {
                                notice: {
                                    text: '<?php echo $this->escapeJsQuote(__("Click on image to view it full sized")) ?>'
                                }
                            }
                        })
                        .zoom({
                            controls: {
                                notice: {
                                    text: '<?php echo $this->escapeJsQuote(__("Click on image to zoom")) ?>'
                                }
                            }
                        })
                        .galleryFullScreen();
            });
        <?php endif; ?>
        })(jQuery);
    </script>
<?php endif; ?>
